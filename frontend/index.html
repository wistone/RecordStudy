<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="学习搭子 - 记录学习，见证成长。个人学习管理系统，帮助您记录每天的学习内容、进度与思考。">
    <meta name="keywords" content="学习记录,学习管理,个人成长,学习搭子">
    <meta name="author" content="学习搭子">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#2563eb">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>学习搭子 - 记录每一步成长</title>
    <link rel="icon" type="image/x-icon" href="study.ico">
    <link rel="shortcut icon" type="image/x-icon" href="study.ico">
    <link rel="apple-touch-icon" href="study.ico">
    <link rel="stylesheet" href="styles/main.css?v=20250825-5">
</head>
<body>
    <div id="app">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-brand">
                    <svg class="logo" viewBox="0 0 40 40" width="32" height="32">
                        <rect x="8" y="8" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"/>
                        <circle cx="20" cy="20" r="6" fill="currentColor" opacity="0.8"/>
                    </svg>
                    <span>学习搭子</span>
                </div>
                <div class="nav-links">
                    <a href="#/" class="nav-link active">首页</a>
                    <a href="#/analytics" class="nav-link">数据分析</a>
                    <a href="#/records" class="nav-link">学习记录</a>
                </div>
                <div class="nav-user">
                    <div class="streak-badge">
                        <span class="streak-icon">🔥</span>
                        <span id="streakDays">0</span>天
                    </div>
                    <div class="user-profile" onclick="toggleUserMenu()">
                        <div class="user-avatar">
                            <span class="avatar-icon">👤</span>
                        </div>
                        <span class="user-name">学习者</span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="dropdown-arrow">
                            <polyline points="6,9 12,15 18,9"></polyline>
                        </svg>
                    </div>
                    
                    <!-- User Menu Dropdown -->
                    <div id="userMenu" class="user-menu">
                        <div class="user-menu-header">
                            <div class="user-menu-avatar">
                                <span class="avatar-icon">👤</span>
                            </div>
                            <div class="user-menu-info">
                                <div class="user-menu-name">学习者</div>
                                <div class="user-menu-email">demo@example.com</div>
                            </div>
                        </div>
                        <div class="user-menu-divider"></div>
                        <div class="user-menu-items">
                            <a href="#" class="user-menu-item" onclick="showProfile()">
                                <span class="menu-icon">👤</span>
                                个人资料
                            </a>
                            <a href="#" class="user-menu-item" onclick="showSettings()">
                                <span class="menu-icon">⚙️</span>
                                设置
                            </a>
                            <div class="user-menu-divider"></div>
                            <a href="#" class="user-menu-item logout" onclick="handleLogout()">
                                <span class="menu-icon">🚪</span>
                                退出登录
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main id="mainContent">
            <!-- Home Page -->
            <div id="homePage" class="page active">
                <div class="container">
                    <!-- Mobile Navigation Tabs -->
                    <div class="mobile-tabs">
                        <a href="#/" class="mobile-tab active" data-page="home">
                            <span class="mobile-tab-icon">🏠</span>
                            <span class="mobile-tab-label">首页</span>
                        </a>
                        <a href="#/analytics" class="mobile-tab" data-page="analytics">
                            <span class="mobile-tab-icon">📊</span>
                            <span class="mobile-tab-label">数据分析</span>
                        </a>
                        <a href="#/records" class="mobile-tab" data-page="records">
                            <span class="mobile-tab-icon">📝</span>
                            <span class="mobile-tab-label">学习记录</span>
                        </a>
                    </div>

                    <!-- Hero Section -->
                    <section class="hero">
                        <h1 class="hero-title">记录学习，见证成长</h1>
                        <p class="hero-subtitle">随手记录每天的学习内容、进度与思考</p>
                        <div class="hero-actions">
                            <button class="btn btn-primary btn-large" onclick="app.showQuickRecord()">
                                <span class="btn-icon">📝</span>
                                开始记录
                            </button>
                        </div>
                    </section>

                    <!-- Learning Summary -->
                    <section class="learning-summary">
                        <h2 class="section-title">学习概览</h2>
                        <div class="summary-cards">
                            <div class="summary-card today">
                                <div class="card-header">
                                    <div class="card-icon">📅</div>
                                    <div class="card-period">今日</div>
                                </div>
                                <div class="card-metrics">
                                    <div class="metric">
                                        <div class="metric-value" id="todayDuration">0</div>
                                        <div class="metric-label">分钟</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-value" id="todayRecords">0</div>
                                        <div class="metric-label">记录</div>
                                    </div>
                                </div>
                            </div>
                            <div class="summary-card week">
                                <div class="card-header">
                                    <div class="card-icon">📊</div>
                                    <div class="card-period">本周</div>
                                </div>
                                <div class="card-metrics">
                                    <div class="metric">
                                        <div class="metric-value" id="weekDuration">0</div>
                                        <div class="metric-label">小时</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-value" id="weekDays">0</div>
                                        <div class="metric-label">活跃天数</div>
                                    </div>
                                </div>
                            </div>
                            <div class="summary-card month">
                                <div class="card-header">
                                    <div class="card-icon">🎯</div>
                                    <div class="card-period">本月</div>
                                </div>
                                <div class="card-metrics">
                                    <div class="metric">
                                        <div class="metric-value" id="monthDuration">0</div>
                                        <div class="metric-label">小时</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-value" id="monthStreak">0</div>
                                        <div class="metric-label">连续天数</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Recent Records -->
                    <section class="recent-records">
                        <div class="section-header">
                            <h2 class="section-title">最近记录</h2>
                            <a href="#/records" class="link-more">查看全部 →</a>
                        </div>
                        <div id="recentRecordsList" class="records-list">
                            <!-- Records will be inserted here -->
                        </div>
                    </section>
                </div>
            </div>

            <!-- Records Page -->
            <div id="recordsPage" class="page">
                <div class="container">
                    <!-- Mobile Navigation Tabs -->
                    <div class="mobile-tabs">
                        <a href="#/" class="mobile-tab" data-page="home">
                            <span class="mobile-tab-icon">🏠</span>
                            <span class="mobile-tab-label">首页</span>
                        </a>
                        <a href="#/analytics" class="mobile-tab" data-page="analytics">
                            <span class="mobile-tab-icon">📊</span>
                            <span class="mobile-tab-label">数据分析</span>
                        </a>
                        <a href="#/records" class="mobile-tab active" data-page="records">
                            <span class="mobile-tab-icon">📝</span>
                            <span class="mobile-tab-label">学习记录</span>
                        </a>
                    </div>

                    <div class="page-header">
                        <h1 class="page-title">学习记录</h1>
                        <button class="btn btn-primary" onclick="app.showQuickRecord()">新建记录</button>
                    </div>
                    
                    <!-- Filters -->
                    <div class="filters">
                        <select class="filter-select" id="typeFilter">
                            <option value="">所有类型</option>
                            <option value="video">视频</option>
                            <option value="podcast">播客</option>
                            <option value="book">书籍</option>
                            <option value="course">课程</option>
                            <option value="article">文章</option>
                            <option value="exercise">题目</option>
                            <option value="project">项目</option>
                            <option value="workout">运动</option>
                            <option value="other">其他</option>
                        </select>
                        <input type="text" class="filter-input" id="searchInput" placeholder="搜索标题或内容...">
                    </div>

                    <!-- Records List -->
                    <div id="recordsList" class="records-list full">
                        <!-- Records will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Record Detail Page -->
            <div id="recordDetailPage" class="page" style="display: none;">
                <div class="container">
                    <!-- Breadcrumb Navigation -->
                    <div class="breadcrumb">
                        <span class="breadcrumb-link" onclick="app.showPage('records')">学习记录</span>
                        <span class="breadcrumb-separator">›</span>
                        <span class="breadcrumb-current">记录详情</span>
                    </div>
                    
                    <!-- Page Header -->
                    <div class="page-header">
                        <h1 id="recordDetailTitle">记录详情</h1>
                        <div class="page-actions">
                            <!-- 按顺序排列：编辑 → 返回列表 → 删除记录 -->
                            <button class="btn btn-secondary" onclick="app.toggleEditMode()" id="editModeBtn">编辑</button>
                            <button class="btn btn-secondary" onclick="app.cancelEdit()" id="cancelEditBtn" style="display: none;">取消</button>
                            <button class="btn btn-success" onclick="app.saveRecordDetail()" id="saveDetailBtn" style="display: none;">保存修改</button>
                            <button class="btn btn-secondary" onclick="app.showPage('records')">返回列表</button>
                            <button class="btn-delete-confirm" onclick="app.confirmDeleteRecord(app.currentRecordId)" id="deleteRecordBtn">删除记录</button>
                        </div>
                    </div>
                    
                    <!-- Record Detail Content - 3 Column Layout -->
                    <div class="record-detail-layout three-column">
                        <!-- Left Column: 基础信息 + 时长信息 + 学习体验 -->
                        <div class="record-detail-left">
                            <div class="detail-section">
                                <h3>基础信息</h3>
                                <div class="detail-fields">
                                    <div class="detail-field">
                                        <label>记录标题</label>
                                        <!-- 编辑模式的输入框 -->
                                        <input type="text" id="recordDetailTitleField" class="detail-input" readonly>
                                        <!-- 预览模式的显示 -->
                                        <div class="detail-preview" id="recordDetailTitlePreview">
                                            <span class="preview-value"></span>
                                        </div>
                                    </div>
                                    <div class="detail-field">
                                        <label>学习形式</label>
                                        <!-- 编辑模式的选择框 -->
                                        <select id="recordDetailFormType" class="detail-select" disabled>
                                            <option value="video">📹 视频</option>
                                            <option value="podcast">🎙️ 播客</option>
                                            <option value="book">📚 书籍</option>
                                            <option value="course">🎓 课程</option>
                                            <option value="article">📄 文章</option>
                                            <option value="exercise">✏️ 题目</option>
                                            <option value="project">💻 项目</option>
                                            <option value="workout">🏃 运动</option>
                                            <option value="other">📌 其他</option>
                                        </select>
                                        <!-- 预览模式的显示 -->
                                        <div class="detail-preview" id="recordDetailFormTypePreview">
                                            <span class="preview-value preview-badge"></span>
                                        </div>
                                    </div>
                                    <div class="detail-field">
                                        <label>发生时间</label>
                                        <!-- 编辑模式的时间输入 -->
                                        <input type="datetime-local" id="recordDetailOccurredAt" class="detail-input" readonly>
                                        <!-- 预览模式的显示 -->
                                        <div class="detail-preview" id="recordDetailOccurredAtPreview">
                                            <span class="preview-value"></span>
                                        </div>
                                    </div>
                                    <div class="detail-field">
                                        <label>总时长 (分钟)</label>
                                        <!-- 编辑模式的数字输入 -->
                                        <input type="number" id="recordDetailDuration" class="detail-input" readonly>
                                        <!-- 预览模式的显示 -->
                                        <div class="detail-preview" id="recordDetailDurationPreview">
                                            <span class="preview-value preview-duration"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="detail-section" id="experienceSection">
                                <h3>学习体验</h3>
                                <div class="detail-fields">
                                    <div class="detail-field">
                                        <label>难度评级</label>
                                        <div class="rating-display" id="recordDetailDifficulty">
                                            <span class="star">☆</span><span class="star">☆</span><span class="star">☆</span><span class="star">☆</span><span class="star">☆</span>
                                        </div>
                                    </div>
                                    <div class="detail-field">
                                        <label>专注度</label>
                                        <div class="rating-display" id="recordDetailFocus">
                                            <span class="star">☆</span><span class="star">☆</span><span class="star">☆</span><span class="star">☆</span><span class="star">☆</span>
                                        </div>
                                    </div>
                                    <div class="detail-field">
                                        <label>精力状态</label>
                                        <div class="rating-display" id="recordDetailEnergy">
                                            <span class="star">☆</span><span class="star">☆</span><span class="star">☆</span><span class="star">☆</span><span class="star">☆</span>
                                        </div>
                                    </div>
                                    <div class="detail-field">
                                        <label>心情记录</label>
                                        <textarea id="recordDetailMood" class="detail-textarea" readonly></textarea>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                        
                        <!-- Middle Column: 学习笔记 -->
                        <div class="record-detail-middle">
                            <div class="detail-section">
                                <h3>学习笔记</h3>
                                <div class="detail-fields">
                                    <textarea id="recordDetailBodyMd" class="detail-textarea large" readonly placeholder="学习笔记和详细内容..."></textarea>
                                    <div id="recordDetailBodyMdPreview" class="markdown-preview" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column: 标签管理 + 关联资源 -->
                        <div class="record-detail-right">
                            <div class="detail-section">
                                <h3>标签管理</h3>
                                <div class="tags-display" id="recordDetailTags">
                                    <!-- Tags will be displayed here -->
                                </div>
                                <div class="tag-editor" id="tagEditor" style="display: none;">
                                    <div class="tag-input-container">
                                        <input type="text" id="newTagInput" class="tag-input" placeholder="输入新标签...">
                                        <button class="btn-small btn-primary" onclick="app.addTagToRecord()" id="addTagBtn">添加/保存</button>
                                    </div>
                                    <div class="tag-suggestions-detail" id="tagSuggestionsDetail">
                                        <!-- Recommended tags will be displayed here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="detail-section" id="resourceSection">
                                <h3>关联资源</h3>
                                <div class="detail-fields" id="resourceFields">
                                    <div class="detail-field">
                                        <label>资源标题</label>
                                        <!-- 编辑模式的输入框 -->
                                        <input type="text" id="resourceDetailTitle" class="detail-input" readonly>
                                        <!-- 预览模式的显示 -->
                                        <div class="detail-preview" id="resourceDetailTitlePreview">
                                            <span class="preview-value"></span>
                                        </div>
                                    </div>
                                    <div class="detail-field">
                                        <label>资源类型</label>
                                        <!-- 编辑模式的选择框 -->
                                        <select id="resourceDetailType" class="detail-select" disabled>
                                            <option value="video">视频</option>
                                            <option value="podcast">播客</option>
                                            <option value="book">书籍</option>
                                            <option value="course">课程</option>
                                            <option value="article">文章</option>
                                            <option value="paper">论文</option>
                                            <option value="exercise">练习</option>
                                            <option value="project">项目</option>
                                            <option value="workout">运动</option>
                                            <option value="other">其他</option>
                                        </select>
                                        <!-- 预览模式的显示 -->
                                        <div class="detail-preview" id="resourceDetailTypePreview">
                                            <span class="preview-value preview-badge"></span>
                                        </div>
                                    </div>
                                    <div class="detail-field">
                                        <label>作者信息</label>
                                        <!-- 编辑模式的输入框 -->
                                        <input type="text" id="resourceDetailAuthor" class="detail-input" readonly>
                                        <!-- 预览模式的显示 -->
                                        <div class="detail-preview" id="resourceDetailAuthorPreview">
                                            <span class="preview-value"></span>
                                        </div>
                                    </div>
                                    <div class="detail-field">
                                        <label>资源链接</label>
                                        <!-- 编辑模式的输入框 -->
                                        <input type="url" id="resourceDetailUrl" class="detail-input" readonly>
                                        <!-- 预览模式的显示 -->
                                        <div class="detail-preview" id="resourceDetailUrlPreview">
                                            <a class="preview-link" href="" target="_blank" rel="noopener noreferrer"></a>
                                        </div>
                                    </div>
                                    <div class="detail-field">
                                        <label>平台信息</label>
                                        <!-- 编辑模式的输入框 -->
                                        <input type="text" id="resourceDetailPlatform" class="detail-input" readonly>
                                        <!-- 预览模式的显示 -->
                                        <div class="detail-preview" id="resourceDetailPlatformPreview">
                                            <span class="preview-value"></span>
                                        </div>
                                    </div>
                                    <div class="detail-field">
                                        <label>ISBN (仅书籍)</label>
                                        <!-- 编辑模式的输入框 -->
                                        <input type="text" id="resourceDetailIsbn" class="detail-input" readonly>
                                        <!-- 预览模式的显示 -->
                                        <div class="detail-preview" id="resourceDetailIsbnPreview">
                                            <span class="preview-value preview-isbn"></span>
                                        </div>
                                    </div>
                                    <div class="detail-field">
                                        <label>资源描述</label>
                                        <!-- 资源描述保持原样（按需求） -->
                                        <textarea id="resourceDetailDescription" class="detail-textarea" readonly></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="detail-section" id="userResourceSection" style="display: none;">
                                <h3>个人资源关系</h3>
                                <div class="detail-fields">
                                    <div class="detail-field">
                                        <label>资源状态</label>
                                        <select id="userResourceStatus" class="detail-select" disabled>
                                            <option value="wishlist">待学习</option>
                                            <option value="learning">学习中</option>
                                            <option value="paused">已暂停</option>
                                            <option value="done">已完成</option>
                                            <option value="reviewing">复习中</option>
                                        </select>
                                    </div>
                                    <div class="detail-field">
                                        <label>个人评分</label>
                                        <div class="rating-display" id="userResourceRating">
                                            <span class="star">☆</span><span class="star">☆</span><span class="star">☆</span><span class="star">☆</span><span class="star">☆</span>
                                        </div>
                                    </div>
                                    <div class="detail-field">
                                        <label>简短评价</label>
                                        <textarea id="userResourceReview" class="detail-textarea" readonly></textarea>
                                    </div>
                                    <div class="detail-field">
                                        <label>收藏状态</label>
                                        <div class="favorite-toggle">
                                            <input type="checkbox" id="userResourceFavorite" disabled>
                                            <label for="userResourceFavorite">收藏此资源</label>
                                        </div>
                                    </div>
                                    <div class="detail-field">
                                        <label>累计学习时长</label>
                                        <div class="readonly-field" id="userResourceTotalDuration">0 分钟</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="detail-section" id="assetsSection" style="display: none;">
                                <h3>附件资源</h3>
                                <div class="assets-display" id="recordDetailAssets">
                                    <!-- Assets will be displayed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Page -->
            <div id="analyticsPage" class="page">
                <div class="container">
                    <!-- Mobile Navigation Tabs -->
                    <div class="mobile-tabs">
                        <a href="#/" class="mobile-tab" data-page="home">
                            <span class="mobile-tab-icon">🏠</span>
                            <span class="mobile-tab-label">首页</span>
                        </a>
                        <a href="#/analytics" class="mobile-tab active" data-page="analytics">
                            <span class="mobile-tab-icon">📊</span>
                            <span class="mobile-tab-label">数据分析</span>
                        </a>
                        <a href="#/records" class="mobile-tab" data-page="records">
                            <span class="mobile-tab-icon">📝</span>
                            <span class="mobile-tab-label">学习记录</span>
                        </a>
                    </div>

                    <h1 class="page-title">数据分析</h1>
                    
                    <!-- Time Stats and Calendar Row -->
                    <section class="stats-row">
                        <!-- Time Stats -->
                        <div class="time-stats-container">
                            <div class="section-header">
                                <h2 class="section-title">学习时长趋势</h2>
                                <div class="period-tabs">
                                    <button class="period-tab active" data-period="week" onclick="app.switchPeriod('week')">周</button>
                                    <button class="period-tab" data-period="month" onclick="app.switchPeriod('month')">月</button>
                                    <button class="period-tab" data-period="year" onclick="app.switchPeriod('year')">年</button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <div id="durationChart" class="chart-placeholder">
                                    <div class="chart-bars" id="chartBars">
                                        <!-- Chart bars will be generated here -->
                                    </div>
                                    <div class="chart-labels" id="chartLabels">
                                        <!-- Chart labels will be generated here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Calendar Widget -->
                        <div class="calendar-widget">
                            <div class="widget-header">
                                <h3>打卡日历</h3>
                                <div class="calendar-nav-mini">
                                    <button class="nav-btn" onclick="app.changeMonth(-1)">‹</button>
                                    <span id="miniCalendarMonth">2024年1月</span>
                                    <button class="nav-btn" onclick="app.changeMonth(1)">›</button>
                                </div>
                            </div>
                            <div id="miniCalendarGrid" class="mini-calendar-grid">
                                <!-- Mini calendar will be generated here -->
                            </div>
                        </div>
                    </section>

                    <!-- Category Stats -->
                    <section class="stats-section">
                        <h2 class="section-title">学习分析</h2>
                        <div class="stats-grid-three">
                            <div class="stat-card">
                                <h3>学习形式分布</h3>
                                <div id="typeStats" class="stat-list">
                                    <!-- Stats will be inserted here -->
                                </div>
                            </div>
                            <div class="stat-card">
                                <h3>热门主题</h3>
                                <div id="weeklyTopics" class="stat-list">
                                    <!-- Stats will be inserted here -->
                                </div>
                            </div>
                            <div class="stat-card">
                                <h3>里程碑成就</h3>
                                <div class="milestone-mini-list">
                                    <div class="milestone-mini-item">
                                        <div class="milestone-mini-icon">🎯</div>
                                        <div class="milestone-mini-content">
                                            <span class="milestone-mini-title">累计100小时</span>
                                            <span class="milestone-mini-date">2024-01-20</span>
                                        </div>
                                    </div>
                                    <div class="milestone-mini-item">
                                        <div class="milestone-mini-icon">📚</div>
                                        <div class="milestone-mini-content">
                                            <span class="milestone-mini-title">连续学习21天</span>
                                            <span class="milestone-mini-date">2024-01-18</span>
                                        </div>
                                    </div>
                                    <div class="milestone-mini-item">
                                        <div class="milestone-mini-icon">🏆</div>
                                        <div class="milestone-mini-content">
                                            <span class="milestone-mini-title">完成5个项目</span>
                                            <span class="milestone-mini-date">2024-01-15</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- AI Summary -->
                    <section class="ai-summary">
                        <h2 class="section-title">AI 智能总结</h2>
                        <div class="summary-content">
                            <div class="summary-insights">
                                <div class="insight-item">
                                    <div class="insight-icon">📈</div>
                                    <div class="insight-text">
                                        <strong>学习趋势：</strong>
                                        <span id="trendInsight">本月学习时长相比上月增长25%，保持良好上升趋势</span>
                                    </div>
                                </div>
                                <div class="insight-item">
                                    <div class="insight-icon">🎯</div>
                                    <div class="insight-text">
                                        <strong>重点方向：</strong>
                                        <span id="focusInsight">AI和编程是你的主要学习方向，占总时长的65%</span>
                                    </div>
                                </div>
                                <div class="insight-item">
                                    <div class="insight-icon">⭐</div>
                                    <div class="insight-text">
                                        <strong>优势表现：</strong>
                                        <span id="strengthInsight">视频学习效率最高，平均专注度达到4.5/5</span>
                                    </div>
                                </div>
                            </div>
                            <div class="next-action">
                                <div class="action-header">
                                    <strong>🚀 下一步行动建议</strong>
                                </div>
                                <div class="action-content">
                                    <span id="nextActionText">建议继续加强实践项目，可以尝试将理论知识应用到实际项目中，提高学习转化率</span>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

        </main>

        <!-- Quick Record Modal -->
        <div id="quickRecordModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>快速记录</h2>
                    <button class="modal-close" onclick="app.closeQuickRecord()">×</button>
                </div>
                <div class="modal-body">
                    <!-- Tab Navigation -->
                    <div class="tabs">
                        <button class="tab-btn active" onclick="app.switchRecordTab('form')">表单记录</button>
                        <button class="tab-btn" onclick="app.switchRecordTab('quick')">随手记</button>
                    </div>

                    <!-- Form Record -->
                    <div id="formRecord" class="tab-content active">
                        <form id="recordForm" class="record-form">
                            <!-- Step 1: Title -->
                            <div class="form-step active" data-step="1">
                                <label class="form-label">标题</label>
                                <input type="text" class="form-input" id="recordTitle" placeholder="输入学习内容标题..." required>
                            </div>

                            <!-- Step 2: Type -->
                            <div class="form-step" data-step="2">
                                <label class="form-label">选择形式类别</label>
                                <div class="type-grid">
                                    <button type="button" class="type-btn" data-type="video">📹 视频</button>
                                    <button type="button" class="type-btn" data-type="podcast">🎙️ 播客</button>
                                    <button type="button" class="type-btn" data-type="book">📚 书籍</button>
                                    <button type="button" class="type-btn" data-type="course">🎓 课程</button>
                                    <button type="button" class="type-btn" data-type="article">📄 文章</button>
                                    <button type="button" class="type-btn" data-type="exercise">✏️ 题目</button>
                                    <button type="button" class="type-btn" data-type="project">💻 项目</button>
                                    <button type="button" class="type-btn" data-type="workout">🏃 运动</button>
                                    <button type="button" class="type-btn" data-type="other">📌 其他</button>
                                </div>
                            </div>

                            <!-- Step 3: Categories -->
                            <div class="form-step" data-step="3">
                                <label class="form-label">内容标签（可多选）</label>
                                <div class="tag-input-container">
                                    <input type="text" class="tag-input" id="tagInput" placeholder="输入标签，如：英语、编程、AI...">
                                    <div class="tag-suggestions">
                                        <span class="tag-suggestion">英语</span>
                                        <span class="tag-suggestion">AI</span>
                                        <span class="tag-suggestion">数学</span>
                                        <span class="tag-suggestion">编程</span>
                                        <span class="tag-suggestion">历史</span>
                                    </div>
                                </div>
                                <div class="selected-tags" id="selectedTags"></div>
                            </div>

                            <!-- Step 4: Duration -->
                            <div class="form-step" data-step="4">
                                <label class="form-label">学习时长（分钟）</label>
                                <input type="number" class="form-input" id="recordDuration" placeholder="25" min="1">
                                <div class="duration-presets">
                                    <button type="button" class="preset-btn" data-duration="25">25分钟</button>
                                    <button type="button" class="preset-btn" data-duration="45">45分钟</button>
                                    <button type="button" class="preset-btn" data-duration="60">1小时</button>
                                    <button type="button" class="preset-btn" data-duration="90">1.5小时</button>
                                </div>
                            </div>

                            <!-- Step 5: Learning Notes -->
                            <div class="form-step" data-step="5">
                                <label class="form-label">学习笔记（可选）</label>
                                <textarea class="form-textarea" id="recordNotes" placeholder="记录学习笔记、要点总结、思考感悟..."></textarea>
                            </div>

                            <!-- Form Navigation -->
                            <div class="form-nav">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-secondary" onclick="app.prevStep()">上一步</button>
                                    <button type="button" class="btn btn-primary" onclick="app.nextStep()">下一步</button>
                                    <button type="submit" class="btn btn-success" style="display:none;">完成记录</button>
                                </div>
                                
                                <!-- Detailed Record Link -->
                                <div class="detailed-record-link">
                                    <a href="javascript:void(0)" onclick="app.createNewDetailedRecord()">
                                        需要填写更多信息？<br>前往详细记录 →
                                    </a>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Quick Note -->
                    <div id="quickNote" class="tab-content">
                        <div class="quick-note-form">
                            <textarea class="quick-input" placeholder="记录一句话、粘贴链接或上传图片..." rows="4"></textarea>
                            <div class="quick-actions">
                                <button class="btn-icon-action" title="上传图片">📷</button>
                                <button class="btn-icon-action" title="添加链接">🔗</button>
                            </div>
                            <button class="btn btn-primary btn-block" onclick="app.saveQuickNote()">智能识别并保存</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Markdown Library -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.2/marked.min.js" integrity="sha384-..." crossorigin="anonymous"></script>
    <!-- Include Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" integrity="sha384-..." crossorigin="anonymous"></script>
    <!-- Include Environment Variables -->
    <script src="js/env.js"></script>
    <!-- Include Cache Service (temporarily disabled) -->
    <!-- <script src="js/cache-service.js?v=20250827-1"></script> -->
    <!-- Include Authentication Service -->
    <script src="js/auth.js?v=20250825-6"></script>
    <!-- Include API Service -->
    <script src="js/api-service.js?v=20250827-nocache"></script>
    <!-- Include Main Application -->
    <script src="js/app.js?v=20250901-arrow-function-fix"></script>
    
    <script>
        let isRedirecting = false; // 防止重复重定向

        // Authentication check and redirect logic
        document.addEventListener('DOMContentLoaded', () => {
            // 使用异步立即执行函数，避免阻塞其他脚本
            (async () => {
                try {
                    // 等待认证服务完全初始化
                    await authService.waitForInitialization();
                    
                    console.log('🔍 检查首页认证状态:', authService.isAuthenticated());
                    
                    // Check authentication status
                    if (!authService.isAuthenticated() && !isRedirecting) {
                        console.log('❌ 未登录，重定向到登录页');
                        isRedirecting = true;
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // 如果已登录，更新用户显示
                    if (authService.isAuthenticated()) {
                        updateUserDisplay(authService.getCurrentUser());
                    }
                    
                    // 监听认证状态变化
                    authService.onAuthStateChange((user) => {
                        console.log('👤 首页认证状态变化:', !!user);
                        if (!user && !isRedirecting) {
                            isRedirecting = true;
                            window.location.href = 'login.html';
                        } else if (user) {
                            updateUserDisplay(user);
                        }
                    });
                } catch (error) {
                    console.error('❌ 认证检查失败:', error);
                    // 即使认证检查失败，也不阻塞其他功能
                }
            })();
        });

        // 监听页面可见性变化，当从个人资料页面返回时刷新用户信息
        document.addEventListener('visibilitychange', async () => {
            if (!document.hidden && authService.isAuthenticated()) {
                console.log('🔄 页面重新可见，刷新用户信息');
                await updateUserDisplay(authService.getCurrentUser());
            }
        });

        // 监听localStorage中的头像更新事件
        window.addEventListener('storage', (event) => {
            if (event.key === 'avatarUpdated' && authService.isAuthenticated()) {
                console.log('📸 检测到头像更新事件');
                // 延迟一点再刷新，确保存储操作完成
                setTimeout(async () => {
                    await updateUserDisplay(authService.getCurrentUser());
                }, 100);
            }
        });

        // 监听来自个人资料页面的消息
        window.addEventListener('message', (event) => {
            if (event.data.type === 'AVATAR_UPDATED' && authService.isAuthenticated()) {
                console.log('📸 收到头像更新消息:', event.data.avatarUrl);
                setTimeout(async () => {
                    await updateUserDisplay(authService.getCurrentUser());
                }, 100);
            }
        });
        
        async function updateUserDisplay(user, profileData = null) {
            try {
                // 🚀 如果传入了profile数据，直接使用；否则才从API获取
                let profile = profileData;
                if (!profile) {
                    profile = await window.apiService.request('/profiles/current', 'GET');
                }
                
                if (profile && !profile.error) {
                    const displayName = profile.display_name || authService.getDisplayName();
                    const userEmail = profile.email || user?.email || 'demo@example.com';
                    const avatarUrl = profile.avatar_url;
                    
                    // Update main user name
                    const userNameElement = document.querySelector('.user-name');
                    if (userNameElement && displayName) {
                        userNameElement.textContent = displayName;
                    }
                    
                    // Update main user avatar
                    const userAvatarElement = document.querySelector('.user-avatar');
                    if (userAvatarElement) {
                        if (avatarUrl) {
                            userAvatarElement.innerHTML = `<img src="${avatarUrl}" alt="头像" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">`;
                        } else {
                            userAvatarElement.innerHTML = '<span class="avatar-icon">👤</span>';
                        }
                    }
                    
                    // Update dropdown menu info
                    const menuNameElement = document.querySelector('.user-menu-name');
                    const menuEmailElement = document.querySelector('.user-menu-email');
                    const menuAvatarElement = document.querySelector('.user-menu-avatar');
                    
                    if (menuNameElement && displayName) {
                        menuNameElement.textContent = displayName;
                    }
                    if (menuEmailElement && userEmail) {
                        menuEmailElement.textContent = userEmail;
                    }
                    if (menuAvatarElement) {
                        if (avatarUrl) {
                            menuAvatarElement.innerHTML = `<img src="${avatarUrl}" alt="头像" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">`;
                        } else {
                            menuAvatarElement.innerHTML = '<span class="avatar-icon">👤</span>';
                        }
                    }
                    
                    console.log('✅ 用户显示信息更新成功', { displayName, avatarUrl });
                } else {
                    // 如果获取资料失败，使用基础信息
                    console.log('⚠️ 无法获取用户资料，使用基础信息');
                    const displayName = authService.getDisplayName();
                    const userEmail = user?.email || 'demo@example.com';
                    
                    // Update main user name
                    const userNameElement = document.querySelector('.user-name');
                    if (userNameElement && displayName) {
                        userNameElement.textContent = displayName;
                    }
                    
                    // Update dropdown menu info
                    const menuNameElement = document.querySelector('.user-menu-name');
                    const menuEmailElement = document.querySelector('.user-menu-email');
                    if (menuNameElement && displayName) {
                        menuNameElement.textContent = displayName;
                    }
                    if (menuEmailElement && userEmail) {
                        menuEmailElement.textContent = userEmail;
                    }
                }
            } catch (error) {
                console.error('❌ 更新用户显示信息失败:', error);
                // 出错时使用基础信息
                const displayName = authService.getDisplayName();
                const userEmail = user?.email || 'demo@example.com';
                
                const userNameElement = document.querySelector('.user-name');
                if (userNameElement && displayName) {
                    userNameElement.textContent = displayName;
                }
            }
        }
        
        // User menu functions
        function toggleUserMenu() {
            const userMenu = document.getElementById('userMenu');
            const userProfile = document.querySelector('.user-profile');
            
            if (userMenu && userProfile) {
                userMenu.classList.toggle('show');
                userProfile.classList.toggle('open');
            }
        }
        
        // Close menu when clicking outside
        document.addEventListener('click', (event) => {
            const userMenu = document.getElementById('userMenu');
            const userProfile = document.querySelector('.user-profile');
            
            if (!userProfile.contains(event.target)) {
                userMenu.classList.remove('show');
                userProfile.classList.remove('open');
            }
        });
        
        function handleLogout() {
            showLogoutConfirm();
        }

        function showLogoutConfirm() {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'logout-confirm-modal';
            confirmModal.innerHTML = `
                <div class="logout-confirm-overlay">
                    <div class="logout-confirm-content">
                        <div class="logout-confirm-header">
                            <h3>确定要退出登录吗？</h3>
                        </div>
                        <div class="logout-confirm-body">
                        </div>
                        <div class="logout-confirm-actions">
                            <button class="btn btn-secondary" onclick="closeLogoutConfirm()">取消</button>
                            <button class="btn-logout-confirm" onclick="executeLogout()">确定</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmModal);
            // 添加动画效果
            setTimeout(() => confirmModal.classList.add('active'), 10);
        }

        function closeLogoutConfirm() {
            const modal = document.querySelector('.logout-confirm-modal');
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);
            }
        }

        async function executeLogout() {
            try {
                const { error } = await authService.signOut();
                if (error) {
                    alert('退出登录失败，请重试');
                } else {
                    // 成功登出，会自动跳转到登录页面
                    window.location.href = 'login.html';
                }
            } catch (error) {
                alert('退出登录失败，请重试');
            }
        }
        
        function showProfile() {
            console.log('📍 点击个人资料菜单');
            toggleUserMenu(); // Close the menu
            
            // 延迟一点再跳转，确保菜单关闭动画不会干扰
            setTimeout(() => {
                console.log('🔄 跳转到个人资料页面');
                window.location.href = 'profile.html';
            }, 50);
        }
        
        function showSettings() {
            window.location.href = 'settings.html';
        }
    </script>
</body>
</html>